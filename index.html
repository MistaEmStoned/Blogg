<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Marco's Blog</title>
<style>
body{font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;margin:0;color:#111;background:#f7f7f8}
.wrap{max-width:1000px;margin:28px auto;padding:18px}
header{display:flex;align-items:center;justify-content:space-between}
.logo{width:56px;height:56px;border-radius:8px;background:#2563eb;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px}
nav a{margin-left:14px;color:#6b7280;text-decoration:none;font-weight:600}
.hero{display:grid;grid-template-columns:1fr 320px;gap:20px;margin-top:18px}
.card{background:white;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
.post{margin-bottom:14px}
.post h3{margin:0 0 6px 0}
.meta{color:#6b7280;font-size:13px;margin-bottom:8px}
.excerpt{color:#374151;font-size:15px;line-height:1.45}
input,textarea{width:100%;padding:10px;border:1px solid #e6e7ea;border-radius:8px;font-size:14px}
button{background:#2563eb;color:white;border:0;padding:10px 12px;border-radius:8px;font-weight:700;cursor:pointer}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
</head>
<body>
<div class="wrap">
<header>
  <div class="logo">MS</div>
  <nav>
    <a href="#">Home</a>
    <a href="#about">About</a>
  </nav>
</header>

<main class="hero">
<section>
  <div class="card" id="posts">
    <h2>Latest posts</h2>
  </div>
</section>

<aside class="card">
  <h4>New Post</h4>
  <input id="authorName" type="text" placeholder="Your name">
  <input id="title" type="text" placeholder="Post title">
  <textarea id="content" rows="6" placeholder="Write your post"></textarea>
  <input id="imageInput" type="file" accept="image/*">
  <button id="saveBtn">Publish</button>
</aside>
</main>

<footer>
  <div style="margin-top:10px">© <span id="year"></span> Marco Sarmiento</div>
</footer>
</div>

<script>
const yearEl = document.getElementById('year');
yearEl.textContent = new Date().getFullYear();

const firebaseConfig = {
  apiKey: "AIzaSyCJjhkq3KdB65hxp6-95fbgbwzWpWAucbI",
  authDomain: "blogg-b66ef.firebaseapp.com",
  projectId: "blogg-b66ef",
  storageBucket: "blogg-b66ef.appspot.com",
  messagingSenderId: "866277401593",
  appId: "1:866277401593:web:324161cdeb92f09fd29328"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();
firebase.auth().signInAnonymously();

const postsEl = document.getElementById('posts');
const titleEl = document.getElementById('title');
const contentEl = document.getElementById('content');
const authorEl = document.getElementById('authorName');
const imageInput = document.getElementById('imageInput');

function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

function renderPosts(posts, currentUid){
  postsEl.innerHTML = '<h2>Latest posts</h2>';
  posts.forEach(p=>{
    const wrap = document.createElement('article');
    wrap.className='post card';
    const date = new Date(p.date).toLocaleString();
    const imageHtml = p.imageUrl ? `<img src="${p.imageUrl}" style="max-width:100%;margin-top:8px;border-radius:8px">` : '';
    wrap.innerHTML=`
      <h3>${escapeHtml(p.title)}</h3>
      <div class="meta">${date} · ${escapeHtml(p.authorName)}</div>
      <div class="excerpt">${escapeHtml(p.content)}</div>
      ${imageHtml}
    `;
    postsEl.appendChild(wrap);
  });
}

function uploadPost(title, content, authorName, fileInput, callback){
  if(fileInput && fileInput.files.length){
    const file = fileInput.files[0];
    const ref = storage.ref('images/'+Date.now()+'_'+file.name);
    ref.put(file).then(snapshot=>{
      snapshot.ref.getDownloadURL().then(url=>{
        callback({title, content, authorName, imageUrl: url});
      }).catch(()=>callback({title, content, authorName}));
    }).catch(()=>callback({title, content, authorName}));
  } else {
    callback({title, content, authorName});
  }
}

firebase.auth().onAuthStateChanged(user=>{
  if(!user) return;
  const uid = user.uid;

  function fetchAndRender(){
    db.collection('posts').orderBy('date','desc').get().then(snapshot=>{
      const posts = snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
      renderPosts(posts, uid);
    });
  }

  fetchAndRender();

  document.getElementById('saveBtn').addEventListener('click',()=>{
    const title=titleEl.value.trim();
    const content=contentEl.value.trim();
    const authorName=authorEl.value.trim()||'Anonymous';
    if(!title||!content){alert('Title and content required');return;}
    uploadPost(title, content, authorName, imageInput, postData=>{
      postData.authorId=uid;
      postData.date=new Date().toISOString();
      db.collection('posts').add(postData).then(()=>{
        titleEl.value=''; contentEl.value=''; imageInput.value='';
        fetchAndRender();
      });
    });
  });
});
</script>
</body>
</html>
