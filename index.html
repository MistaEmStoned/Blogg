<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Marco's Blog - Firebase</title>
  <meta name="description" content="Personal blog with Firebase anonymous auth and per-user posts.">
  <style>
    :root{--max:1000px;--accent:#2563eb;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:#111;background:#f7f7f8}
    body.dark{background:#0b1220;color:#e6eef8}
    .wrap{max-width:var(--max);margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px}
    nav a{margin-left:14px;color:var(--muted);text-decoration:none;font-weight:600}
    .hero{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:18px}
    .card{background:white;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
    body.dark .card{background:#071222;box-shadow:none}
    .post{margin-bottom:14px}
    .post h3{margin:0 0 6px 0}
    .meta{color:var(--muted);font-size:13px;margin-bottom:8px}
    .excerpt{color:#374151;font-size:15px;line-height:1.45}
    body.dark .excerpt{color:#d7e6fb}
    .sidebar h4{margin-top:0}
    .new-post{display:flex;flex-direction:column;gap:8px}
    input[type=text],textarea,select{width:100%;padding:10px;border:1px solid #e6e7ea;border-radius:8px;font-size:14px;background:transparent}
    body.dark input,body.dark textarea,body.dark select{border-color:#123445;color:#dceffb}
    button{background:var(--accent);color:white;border:0;padding:10px 12px;border-radius:8px;font-weight:700;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .tag{background:#eef2ff;color:#1e3a8a;padding:6px 8px;border-radius:999px;font-size:13px;cursor:pointer}
    body.dark .tag{background:#07314a;color:#9ad0ff}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .search{flex:1}
    .profile{display:flex;gap:10px;align-items:center}
    .avatar{width:56px;height:56px;border-radius:8px;object-fit:cover;background:#e2e8f0}
    .small{font-size:13px;color:var(--muted)}
    .post-actions{display:flex;gap:8px;margin-top:8px}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.4)}
    .modal .card{max-width:720px;width:92%}
    .preview{border:1px solid #e6e7ea;padding:10px;border-radius:8px;min-height:80px;background:#fff}
    body.dark .preview{background:#071222;border-color:#123445}
    @media (max-width:880px){.hero{grid-template-columns:1fr}.logo{width:48px;height:48px}.hero{grid-template-columns:1fr 320px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">MS</div>
        <div>
          <div style="font-weight:800;font-size:18px">Marco Sarmiento</div>
          <div class="small">Notes on code, study, life</div>
        </div>
      </div>
      <nav>
        <a href="#">Home</a>
        <a href="#about">About</a>
        <a href="#contact">Contact</a>
      </nav>
    </header>

    <main class="hero">
      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="controls" style="flex:1">
              <input id="search" class="search" type="text" placeholder="Search by title or content or tag">
              <select id="sort">
                <option value="new">Newest</option>
                <option value="old">Oldest</option>
                <option value="alpha">Title A-Z</option>
              </select>
              <button id="darkToggle" title="Toggle theme">Theme</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;margin-left:12px">
              <button id="exportBtn" title="Download backup">Export</button>
              <input id="importFile" type="file" accept="application/json" style="display:none">
              <button id="importBtn">Import</button>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div id="posts" class="card">
          <h2 style="margin-top:0">Your posts</h2>
          <div class="muted" id="userInfo">Connecting...</div>
          <!-- posts render here -->
        </div>

        <div style="height:20px"></div>

        <div class="card">
          <h3 style="margin:0 0 8px 0">Quick tips</h3>
          <ul style="margin:0;padding-left:18px;color:#374151">
            <li>Use short titles.</li>
            <li>Write one idea per paragraph.</li>
            <li>Save drafts in your browser.</li>
          </ul>
        </div>
      </section>

      <aside class="sidebar">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h4 style="margin:0">New post</h4>
            <div class="profile">
              <img id="avatar" class="avatar" src="" alt="avatar" title="Profile photo">
              <div style="display:flex;flex-direction:column">
                <div id="displayName" style="font-weight:700">Your name</div>
                <div class="small">Private posts only you see</div>
              </div>
            </div>
          </div>

          <div class="new-post" style="margin-top:10px">
            <input id="nameInput" type="text" placeholder="Type your display name">
            <input id="title" type="text" placeholder="Post title">
            <textarea id="content" rows="6" placeholder="Write your post here. Markdown supported."></textarea>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="tagInput" type="text" placeholder="Comma separated tags" style="flex:1">
              <button id="saveBtn">Publish</button>
            </div>
            <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
              <button id="previewToggle">Live preview</button>
              <button id="saveDraft">Save draft</button>
              <input id="avatarFile" type="file" accept="image/*" style="display:none">
              <button id="avatarBtn">Upload photo</button>
            </div>
            <div class="muted">Posts save to Firebase. Your name is public next to each post.</div>
          </div>

          <div style="margin-top:10px">
            <div id="livePreview" class="preview" style="display:none"></div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="card">
          <h4>About</h4>
          <p style="margin:0;color:#374151;font-size:14px">A compact blog template for study notes, project logs, and short essays. Your posts are stored under your account id.</p>
          <div class="tags" id="tags"></div>
        </div>

        <div style="height:14px"></div>

        <div class="card">
          <h4>Drafts</h4>
          <div id="draftList" style="display:flex;flex-direction:column;gap:8px;margin-top:8px"></div>
        </div>
      </aside>
    </main>

    <footer>
      <div class="card" style="display:inline-block;padding:10px 14px;border-radius:10px">Built with Firebase and plain JavaScript</div>
      <div style="margin-top:10px">© <span id="year"></span> Marco Sarmiento</div>
    </footer>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>


  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

  <script>
      const firebaseConfig = {
    apiKey: "AIzaSyCJjhkq3KdB65hxp6-95fbgbwzWpWAucbI",
    authDomain: "blogg-b66ef.firebaseapp.com",
    projectId: "blogg-b66ef",
    storageBucket: "blogg-b66ef.firebasestorage.app",
    messagingSenderId: "866277401593",
    appId: "1:866277401593:web:324161cdeb92f09fd29328",
    measurementId: "G-N6Y00ZNR3J"
};

    // Do not change below unless you know what you do
    const storageKey = 'ms.blog.posts.v1'
    const draftKey = 'ms.blog.drafts.v1'
    const postsEl = document.getElementById('posts')
    const titleEl = document.getElementById('title')
    const contentEl = document.getElementById('content')
    const tagInput = document.getElementById('tagInput')
    const tagsEl = document.getElementById('tags')
    const yearEl = document.getElementById('year')
    const avatarEl = document.getElementById('avatar')
    const avatarFile = document.getElementById('avatarFile')
    const avatarBtn = document.getElementById('avatarBtn')
    const saveDraftBtn = document.getElementById('saveDraft')
    const draftList = document.getElementById('draftList')
    const previewToggle = document.getElementById('previewToggle')
    const livePreview = document.getElementById('livePreview')
    const searchEl = document.getElementById('search')
    const sortEl = document.getElementById('sort')
    const darkToggle = document.getElementById('darkToggle')
    const exportBtn = document.getElementById('exportBtn')
    const importBtn = document.getElementById('importBtn')
    const importFile = document.getElementById('importFile')
    const nameInput = document.getElementById('nameInput')
    const displayNameEl = document.getElementById('displayName')
    const userInfoEl = document.getElementById('userInfo')
    yearEl.textContent = new Date().getFullYear()

    let firebaseApp
    let db
    let auth
    let currentUser = null
    let postsRef = null

    function uid(){return Math.random().toString(36).slice(2,9)}

    function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c])}

    function initFirebase(){
      if(!firebaseConfig || !firebaseConfig.projectId){
        userInfoEl.textContent = 'Paste Firebase config in the file to enable cloud mode.'
        renderLocalFallback()
        return
      }
      firebaseApp = firebase.initializeApp(firebaseConfig)
      auth = firebase.auth()
      db = firebase.firestore()

      auth.onAuthStateChanged(user=>{
        if(user){
          currentUser = user
          postsRef = db.collection('users').doc(user.uid).collection('posts')
          loadProfileFromLocal()
          displayNameEl.textContent = localStorage.getItem('ms.blog.name') || 'Your name'
          userInfoEl.textContent = 'Connected as ' + (localStorage.getItem('ms.blog.name') || 'anonymous')
          listenUserPosts()
        } else {
          signInAnon()
        }
      })

      signInAnon()
    }

    function signInAnon(){
      auth.signInAnonymously().catch(err=>{
        console.error(err)
        userInfoEl.textContent = 'Anonymous sign-in failed. Using local mode.'
        renderLocalFallback()
      })
    }

    function listenUserPosts(){
      if(!postsRef) return
      postsRef.orderBy('date','desc').onSnapshot(snap=>{
        const list = []
        snap.forEach(doc=>{ const p = doc.data(); p.id = doc.id; list.push(p) })
        renderFromList(list)
      })
    }

    function renderFromList(list){
      postsEl.innerHTML = '<h2 style="margin-top:0">Your posts</h2>'
      if(!currentUser){ postsEl.innerHTML += '<div class="muted">Not connected</div>'; return }
      if(list.length === 0) postsEl.innerHTML += '<div class="muted">No posts yet</div>'
      list.forEach(p=>{
        const wrap = document.createElement('article')
        wrap.className = 'post card'
        wrap.innerHTML = `
          <h3>${escapeHtml(p.title)}</h3>
          <div class="meta">${p.date} · ${escapeHtml((p.tags||[]).join(', '))}</div>
          <div class="excerpt">${escapeHtml(p.content.slice(0,160))}</div>
          <div class="post-actions">
            <button data-id="${p.id}" class="open">Read</button>
            <button data-id="${p.id}" class="edit">Edit</button>
            <button data-id="${p.id}" class="del" style="background:#ef4444">Delete</button>
          </div>
        `
        postsEl.appendChild(wrap)
      })
    }

    function renderLocalFallback(){
      // load posts from localStorage if firebase not configured
      const list = loadPosts()
      renderFromList(list)
    }

    // local storage functions remain for fallback and drafts
    function loadPosts(){
      const raw = localStorage.getItem(storageKey)
      try{ return raw ? JSON.parse(raw) : [] } catch(e){ return [] }
    }
    function savePosts(list){ localStorage.setItem(storageKey, JSON.stringify(list)) }

    // create post in Firestore
    async function createPostCloud(title,content,tags,name){
      if(!postsRef) return
      const data = { title, content, tags, authorName:name||'', date:new Date().toISOString().slice(0,10) }
      await postsRef.add(data)
    }

    // update post
    async function updatePostCloud(id, title, content, tags){
      if(!postsRef) return
      await postsRef.doc(id).update({title,content,tags})
    }

    // delete post
    async function deletePostCloud(id){ if(!postsRef) return await postsRef.doc(id).delete() }

    // ui handlers
    document.getElementById('saveBtn').addEventListener('click',async()=>{
      const t = titleEl.value.trim()
      const c = contentEl.value.trim()
      const rawTags = tagInput.value.split(',').map(x=>x.trim()).filter(Boolean)
      const name = nameInput.value.trim() || localStorage.getItem('ms.blog.name') || ''
      if(!t || !c){ alert('Title and content required') ; return }
      if(currentUser && postsRef){
        await createPostCloud(t,c,rawTags,name)
      } else {
        const list = loadPosts()
        const post = {id:uid(),title:t,date:new Date().toISOString().slice(0,10),excerpt:c.slice(0,160),content:c,tags:rawTags,authorName:name}
        list.unshift(post)
        savePosts(list)
        renderFromList(list)
      }
      nameInput.value = ''
      titleEl.value='';contentEl.value='';tagInput.value=''
      localStorage.setItem('ms.blog.name', name)
      displayNameEl.textContent = name || 'Your name'
    })

    postsEl.addEventListener('click',async e=>{
      const id = e.target.dataset.id
      if(!id) return
      if(e.target.classList.contains('del')){
        if(!confirm('Delete post?')) return
        if(currentUser && postsRef){ await deletePostCloud(id) } else {
          const list = loadPosts().filter(p=>p.id!==id)
          savePosts(list)
          renderFromList(list)
        }
        return
      }
      if(e.target.classList.contains('open')){
        const postDocs = currentUser && postsRef ? await postsRef.doc(id).get() : null
        const post = postDocs ? postDocs.data() : loadPosts().find(p=>p.id===id)
        if(!post) return
        showModal(post)
      }
      if(e.target.classList.contains('edit')){
        const postDocs = currentUser && postsRef ? await postsRef.doc(id).get() : null
        const post = postDocs ? postDocs.data() : loadPosts().find(p=>p.id===id)
        if(!post) return
        titleEl.value = post.title
        contentEl.value = post.content
        tagInput.value = (post.tags||[]).join(', ')
        document.getElementById('saveBtn').textContent = 'Update'
        document.getElementById('saveBtn').dataset.update = id
      }
    })

    document.getElementById('saveBtn').addEventListener('click',async function(){
      const btn = this
      if(!btn.dataset.update) return
      const id = btn.dataset.update
      const t = titleEl.value.trim()
      const c = contentEl.value.trim()
      const rawTags = tagInput.value.split(',').map(x=>x.trim()).filter(Boolean)
      if(currentUser && postsRef){
        await updatePostCloud(id,t,c,rawTags)
      } else {
        const list = loadPosts()
        const idx = list.findIndex(p=>p.id===id)
        if(idx!==-1){ list[idx].title = t; list[idx].content = c; list[idx].tags = rawTags; savePosts(list) }
        renderFromList(list)
      }
      btn.textContent='Publish'
      delete btn.dataset.update
      titleEl.value='';contentEl.value='';tagInput.value=''
    })

    function showModal(p){
      const modal = document.createElement('div')
      modal.className = 'modal'
      modal.innerHTML = `
        <div class="card">
          <h2 style="margin-top:0">${escapeHtml(p.title)}</h2>
          <div class="muted" style="margin-bottom:8px">${p.date} · ${escapeHtml((p.tags||[]).join(', '))} · by ${escapeHtml(p.authorName||'anonymous')}</div>
          <div id="modalBody" style="color:#111;font-size:15px;line-height:1.6"></div>
          <div style="text-align:right;margin-top:16px"><button id="closeModal">Close</button></div>
        </div>
      `
      document.body.appendChild(modal)
      const body = document.getElementById('modalBody')
      const html = marked.parse(p.content)
      body.innerHTML = DOMPurify.sanitize(html)
      document.getElementById('closeModal').addEventListener('click',()=>modal.remove())
    }

    // preview
    previewToggle.addEventListener('click',()=>{
      const on = localStorage.getItem('ms.blog.preview') === '1'
      if(on){ localStorage.removeItem('ms.blog.preview'); livePreview.style.display='none'; previewToggle.textContent='Live preview' ; return }
      localStorage.setItem('ms.blog.preview','1')
      livePreview.style.display='block'
      previewToggle.textContent='Hide preview'
      updatePreview()
    })

    function updatePreview(){
      if(localStorage.getItem('ms.blog.preview') !== '1') return
      const html = marked.parse(contentEl.value || '')
      livePreview.innerHTML = DOMPurify.sanitize(html)
    }
    contentEl.addEventListener('input',updatePreview)

    // drafts
    saveDraftBtn.addEventListener('click',()=>{
      const d = loadDrafts()
      const id = uid()
      d.unshift({id,title:titleEl.value,content:contentEl.value,tags:tagInput.value,date:new Date().toISOString().slice(0,10)})
      localStorage.setItem(draftKey,JSON.stringify(d))
      renderDrafts()
    })

    function loadDrafts(){
      const raw = localStorage.getItem(draftKey)
      try{ return raw ? JSON.parse(raw) : [] } catch(e){ return [] }
    }

    function renderDrafts(){
      const d = loadDrafts()
      draftList.innerHTML = ''
      d.slice(0,8).forEach(item=>{
        const el = document.createElement('div')
        el.style.display='flex'
        el.style.justifyContent='space-between'
        el.style.alignItems='center'
        el.innerHTML = `<div style="flex:1"><strong>${escapeHtml(item.title||'(no title)')}</strong><div class='small'>${item.date}</div></div><div style='display:flex;gap:6px'><button data-id='${item.id}' class='loadDraft'>Load</button><button data-id='${item.id}' class='delDraft' style='background:#ef4444'>Delete</button></div>`
        draftList.appendChild(el)
      })
    }

    draftList.addEventListener('click',e=>{
      const id = e.target.dataset.id
      if(!id) return
      if(e.target.classList.contains('loadDraft')){
        const d = loadDrafts()
        const item = d.find(x=>x.id===id)
        if(!item) return
        titleEl.value = item.title
        contentEl.value = item.content
        tagInput.value = item.tags
      }
      if(e.target.classList.contains('delDraft')){
        const d = loadDrafts().filter(x=>x.id!==id)
        localStorage.setItem(draftKey,JSON.stringify(d))
        renderDrafts()
      }
    })

    // autosave input to session
    function autosave(){
      const payload = {title:titleEl.value,content:contentEl.value,tags:tagInput.value,name:nameInput.value}
      sessionStorage.setItem('ms.blog.autosave',JSON.stringify(payload))
    }
    setInterval(autosave,3000)
    window.addEventListener('load',()=>{
      const a = sessionStorage.getItem('ms.blog.autosave')
      if(a){
        try{ const p = JSON.parse(a); if(p.title||p.content) { titleEl.value=p.title||''; contentEl.value=p.content||''; tagInput.value=p.tags||''; nameInput.value=p.name||'' } }catch(e){}
      }
      applyTheme()
      initFirebase()
      renderDrafts()
    })

    // profile image local
    avatarBtn.addEventListener('click',()=>avatarFile.click())
    avatarFile.addEventListener('change',()=>{
      const f = avatarFile.files[0]
      if(!f) return
      const r = new FileReader()
      r.onload = ()=>{
        avatarEl.src = r.result
        localStorage.setItem('ms.blog.profile', JSON.stringify({avatar:r.result}))
      }
      r.readAsDataURL(f)
    })

    function loadProfileFromLocal(){
      const raw = localStorage.getItem('ms.blog.profile')
      if(!raw) return
      try{ const p = JSON.parse(raw); if(p.avatar) avatarEl.src = p.avatar }catch(e){}
    }

    // export import local
    exportBtn.addEventListener('click',()=>{
      const data = currentUser && postsRef ? [] : loadPosts()
      const blob = new Blob([JSON.stringify(data, null, 2)],{type:'application/json'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = 'ms-blog-backup.json'
      document.body.appendChild(a)
      a.click()
      a.remove()
      URL.revokeObjectURL(url)
    })

    importBtn.addEventListener('click',()=>importFile.click())
    importFile.addEventListener('change',()=>{
      const f = importFile.files[0]
      if(!f) return
      const r = new FileReader()
      r.onload = ()=>{
        try{
          const parsed = JSON.parse(r.result)
          if(Array.isArray(parsed)){
            savePosts(parsed)
            renderLocalFallback()
            alert('Import complete')
          } else { alert('Invalid file') }
        }catch(e){ alert('Invalid file') }
      }
      r.readAsText(f)
    })

    // theme
    function applyTheme(){
      const t = localStorage.getItem('ms.blog.theme')
      if(t === 'dark') document.body.classList.add('dark')
      else document.body.classList.remove('dark')
    }
    darkToggle.addEventListener('click',()=>{
      const dark = document.body.classList.toggle('dark')
      localStorage.setItem('ms.blog.theme', dark ? 'dark' : 'light')
    })

    // search and sort
    searchEl.addEventListener('input',()=>{
      if(currentUser && postsRef) return // cloud listens
      renderLocalFallback()
    })
    sortEl.addEventListener('change',()=>{
      if(currentUser && postsRef) return
      renderLocalFallback()
    })

  </script>
</body>
</html>
